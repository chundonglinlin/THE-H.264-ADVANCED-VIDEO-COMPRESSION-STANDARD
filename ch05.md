# H.264 语法

## 5.1 引言

H.264 视频是以遵守 H.264/AVC 特定语法格式的视频序列。此语法在H.264行业标准中定义，并指定与H.264兼容的视频序列的确切结构。在语法元素方面，描述编码序列不同方面的参数，以及每个元素表示为二进制代码。语法是分层的，从最高层次，视频序列层次，到各个编码帧或字段（访问单元）和访问单元子集（片）到宏块和块。控制参数作为单独的语法部分存贮，比如参数集，或者作为宏块层的一部分。本章详细研究了H.264/AVC语法，首先概述了帧和图片结构以及处理，然后介绍了语法层次结构的每个主要层。

### 5.1.1 一个语法示例的标注

H.264/AVC标准中的各种语法部分将在本章后面的部分中通过“从编码视频序列中提取”加以说明。这些语法元素都是通过使用 JM 软件的 Trace 模式生成的，关于该软件的描述将在 第 9 章给出。每个语法例子都会按照如下方式呈现，如表 5.1:

表 5.1 语法例子：格式   
| 参数 | 二进制 | 符号 | 描述 |  
|:----:|:-----:|:-----:|:-----:|  
| profile_idc| 1000010 | 66 | Baseline Profile |  

H.264语法的选定部分以语法图的形式呈现，如图5.13所示。

需要强调的是，本章中的语法示例、图表和说明仅供说明。语法和语义的详细解释、语法元素的含义在H.264/AVC标准中给出。

## 5.2 H.264 语法  

H.264/AVC 语法的组织架构如图 5.1 所示。NAL 是有一系列 NAL 单元组成(章节 5.4)。SPS 和 PPS 是给到解码端的标记特定控制参数的 NAL 单元。编码视频数据以视频编码层（VCL）NAL单元（称为编码片）进行通信。存取单元，编码帧或场，由一个或多个 Slice 组成。在 Slice 层，每个 Slice 包含一个 Slice 头和 Slice Data。Slice Data 是由一些列编码宏块(MB) 和 Skip 宏块组成，Skip 宏块指示符表示某些宏块位置不包含数据的宏块。每个编码宏块（第5.7节）包含以下语法元素：

* MB 类型：来自一个参考帧的 I(帧内编码)、P(帧间编码)，来自一个或两个参考帧的B(帧间编码)。  
* 预测信息：对 I 宏块中的预测模式，对P、B宏块的参考帧和运动矢量。  
* 编码宏块模式 CBP:指示 luma 和 chroma 块，包含非零残差系数。  
* 量化参数 QP，对于每个 CBP≠0 的宏块。  
* 残差数据，对于每个含有非零残差系数的块。  

编码视频序列从（IDR）访问单元开始，该访问单元由一个或多个IDR片（一种特殊类型的帧内编码片）组成。随后的视频帧或场（描述为访问单元）被编码为 Slice。视频序列在接到新的 IDR Slice 时，发出新的编码序列的信号或传输完成时结束。

语法元素的所有主要章节都在表格 5.2 中。每个 NAL 单元包含一个 RBSP(Raw Byte Sequence Payload)，由一系列语法元素组成。H.264 的语法元素是由变长编码的二进制组成。因此，一个 NAL 单元中的语法元素序列不一定适合整数个字节。为了是的 RBSP的长度是整数，会在 RBSP 内容的最后添加数值为 0 的 bit。RBSP语法元素可以作为一个完整的包来传输或存储。某些语法节包含子节： SPS 包含 scaling_list 和 vui 以及总是包含 rbsp_trailing_bits。有些语法节不再包含子节，比如 scaling_list 不再包含子节。

在详细讨论语法部分之前，有必要检查 H.264/AVC 处理帧、场和图像的方式。

## 5.3 帧、场和图像

## 5.4 NAL 单元

## 5.5 参数集

## 5.6 Slice 层

## 5.7 宏块层

### 5.7.1 概述

如图 5.13 所示，宏块层包含能够解码单独宏块的所有必要的语法元素。

**mb_type** 指示当前宏块的编码类型，I/SI/P/B，以及宏块预测和编码的更深层次信息。 一个 I 宏块可以在任意 slice 类型中，编码不需要参考其他 slice。
