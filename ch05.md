# H.264 语法

## 5.1 引言

H.264 视频是以遵守 H.264/AVC 特定语法格式的视频序列。此语法在H.264行业标准中定义，并指定与H.264兼容的视频序列的确切结构。在语法元素方面，描述编码序列不同方面的参数，以及每个元素表示为二进制代码。语法是分层的，从最高层次，视频序列层次，到各个编码帧或字段（访问单元）和访问单元子集（片）到宏块和块。控制参数作为单独的语法部分存贮，比如参数集，或者作为宏块层的一部分。本章详细研究了H.264/AVC语法，首先概述了帧和图片结构以及处理，然后介绍了语法层次结构的每个主要层。

### 5.1.1 一个语法示例的标注

H.264/AVC标准中的各种语法部分将在本章后面的部分中通过“从编码视频序列中提取”加以说明。这些语法元素都是通过使用 JM 软件的 Trace 模式生成的，关于该软件的描述将在 第 9 章给出。每个语法例子都会按照如下方式呈现，如表 5.1:

表 5.1 语法例子：格式   
| 参数 | 二进制 | 符号 | 描述 |  
|:----:|:-----:|:-----:|:-----:|  
| profile_idc| 1000010 | 66 | Baseline Profile |  

H.264语法的选定部分以语法图的形式呈现，如图5.13所示。

需要强调的是，本章中的语法示例、图表和说明仅供说明。语法和语义的详细解释、语法元素的含义在H.264/AVC标准中给出。

## 5.2 H.264 语法  

H.264/AVC 语法的组织架构如图 5.1 所示。NAL 是有一系列 NAL 单元组成(章节 5.4)。SPS 和 PPS 是给到解码端的标记特定控制参数的 NAL 单元。编码视频数据以视频编码层（VCL）NAL单元（称为编码片）进行通信。存取单元，编码帧或场，由一个或多个 Slice 组成。在 Slice 层，每个 Slice 包含一个 Slice 头和 Slice Data。Slice Data 是由一些列编码宏块(MB) 和 Skip 宏块组成，Skip 宏块指示符表示某些宏块位置不包含数据的宏块。每个编码宏块（第5.7节）包含以下语法元素：

* MB 类型：来自一个参考帧的 I(帧内编码)、P(帧间编码)，来自一个或两个参考帧的B(帧间编码)。  
* 预测信息：对 I 宏块中的预测模式，对P、B宏块的参考帧和运动矢量。  
* 编码宏块模式 CBP:指示 luma 和 chroma 块，包含非零残差系数。  
* 量化参数 QP，对于每个 CBP≠0 的宏块。  
* 残差数据，对于每个含有非零残差系数的块。  

编码视频序列从（IDR）访问单元开始，该访问单元由一个或多个IDR片（一种特殊类型的帧内编码片）组成。随后的视频帧或场（描述为访问单元）被编码为 Slice。视频序列在接到新的 IDR Slice 时，发出新的编码序列的信号或传输完成时结束。

语法元素的所有主要章节都在表格 5.2 中。每个 NAL 单元包含一个 RBSP(Raw Byte Sequence Payload)，由一系列语法元素组成。H.264 的语法元素是由变长编码的二进制组成。因此，一个 NAL 单元中的语法元素序列不一定适合整数个字节。为了是的 RBSP的长度是整数，会在 RBSP 内容的最后添加数值为 0 的 bit。RBSP语法元素可以作为一个完整的包来传输或存储。某些语法节包含子节： SPS 包含 scaling_list 和 vui 以及总是包含 rbsp_trailing_bits。有些语法节不再包含子节，比如 scaling_list 不再包含子节。

在详细讨论语法部分之前，有必要检查 H.264/AVC 处理帧、场和图像的方式。

## 5.3 帧、场和图像

## 5.4 NAL 单元

编码的 H.264 数据通过一些列的包存储或传输，简称网络抽象层，NAL 单元。每个 NAL 单元由一个字节的 NALU 头和一个包含控制信息或编码视频数据的字节流组成。Slice Header 指示出 NALU 类型(其中一些列在表 5.6 中)以及 NALU 的重要性。用作参考(即用于预测未来帧)的参数集和 Slice 被认为是高优先级的，因为它们的丢失可能使随后的编码 Slice 难以解码。非参考 Slice 被认为对解码器不太重要，因为他们的丢失不会影响任何未来帧的解码。该信息科选择性地用于在传输期间对某些 NALU 进行优先级排序(第 8 章)。

编码 Slice 被描述Wie视频编码层(VLC) NAL 单元。编码序列从 IDR 接入单元开始，该 IDR 接入单元由一个或多个 IDR Slice 组成，每个 IDR Slice 都是帧内编码 Slice。之后是默认的 Slice 类型，即非 IDR 编码的 Slice 或数据分区。`Data Partitioned slices carry
different components of coded video data in separate NAL units, which may be useful in
error-prone transport situations. Non-VCL NAL units include Parameter Sets, Supplemental
Enhancement Information parameters that may be useful for decoding and displaying video
data, but are not essential for correct decoding, and delimiters that define boundaries between
coded sections.
Each NALU may be transported in one or more network packets, streamed sequentially as
a byte stream or encapsulated in a media file (Chapter 8).`

## 5.5 参数集

## 5.6 Slice 层

### 5.6.1 Slice 类型

每个编码的图片（一个编码帧或场），由一个或多个 Slice 组成，每个 Slice 包含 Slice 头，后跟着整数个宏块。Slice 中的宏块数不是固定的。编码 Slices 之间的数据相互依懒性非常小，这有助于限制 slice 之间的错误传播。Slice 大小选择的可能场景包括：  

* 每张图像一个 Slice，许多 H.264 编码应用中的常见做法。  
* 每张图像 N 个 Slice，每个 Slice 包含 N 个宏块， M 和 N 是整数。每个编码 Slice 中的字节数根据图片区域中的运动量和细节而变化。  
* 每张图像 N 个 Slice, 包含不同数量的宏块，选择这些宏块使得每个 Slice 的字节数大致保持不变。例如，如果每个 Slice 被映射到固定大小的网络分组，则这可能是有用的。

表 5.9 列出了可用的 Slice 类型，以及每个 Slice 中可能存在的宏块类型。注意，B Slice 可能包含 B、P或I宏块类型。编码器可以根据视频序列的内容在这些类型之间进行选择。宏块类型将在第5.7.1节中进一步解释。

### 5.6.2 Slice Header

Slice Header 传送 Slice 中所有宏块的公共信息。例如决定允许哪些宏块类型的 Slice 类型、Slice 对应的帧编号、参考图像设置和默认量化参数(QP)。表 5.10 给出了 I Slice 中的Slice Header。这是第一个 I Slice，因此是 IDR Slice.默认的 QP 被设置成了初始序列值 26 加 4。P Slice 的 头如表 5.11 所示。这是第 1 帧， POC 值为 2。注意，POC 的每完整帧增加 2，见第 5.3.2 节。有一个活动的参考图像恰好是第 0 帧。

### 5.6.3 Slice Data

Slice 数据部分由一些列宏块组成。不包含数据的宏块(即 skip 宏块)，在许多编码序列中非常常见。它由 mb_skip_run (skip 宏块序列的计数，使用 CAVLC 熵编码)或 mb_skip_flag (表示单个 skip 宏块，使用 CABAC 熵编码)发出信号。skip 宏块可能出现在P/SP或B Slice 中。一个完整的 Slice 数据段由编码和 skip 宏块组成，这些宏块构成一个编码 Slice(如图 5.1)。

## 5.7 宏块层

### 5.7.1 概述

如图 5.13 所示，宏块层包含能够解码单独宏块的所有必要的语法元素。

**mb_type** 指示当前宏块的编码类型，I/SI/P/B，以及宏块预测和编码的更深层次信息。 一个 I 宏块可以在任意 slice 类型中，编码不需要参考其他 slice。P 宏块发生在 P 或 SP Slice 中，且与一个预测参考进行帧间编码。B 宏块发生在 B Slice 中，且与两个预测参考进行帧间编码。表5.12 总结了由码字**mb_type**发出信号的信息。请注意，对于 P 或 B Slice 中的 skip MB, mb_type 实际上并没有传输，每当在片数据中发送 mb_skip 信号时，这些宏块类型会被推断出来。  

**transform_size_8x8_flag**仅仅在 High Profile 码流中才会出现，根据宏块类型，它只会出现在两个位置(如图 5.13)，并且不会出现在帧内 16x16 宏块中。此标志表示可选的 8x8 整数变换用于 luma 块，而不是默认的 4x4 整数变换(第 7 章)。

**mb_pred**，对于除具有 8x8 分区尺寸的 P/B 以外的所有宏块类型。**sub_mb_pred**，对于 8x8 分区尺寸的 P/B 宏块，指示了宏块使用的帧间/帧内预测(第 6 章 和 5.7.3 节)。

**coded_block_pattern** 是宏块的独立语法元素，而不是 16x16 类型。可能的取值范围是0-47,由如下规则创建：  

    (i) coded_block_pattern 的低四位,b3b2b1b0,指明了四个 8x8 luma 块是否有1个或多个非零转换系数。1：非零系数存在；0：不存在非零系数。   
    (ii)高两位,b5b4,可以是00b，指明没有色度系数；01b指明色度 DC 系数存在，没有 AC 系数；或者10b，指明色度 DC 系数可能存在，色度 AC 系数存在。  

表格 5.13 给出了三个例子：√表示块中可能存在系数， 0 表示不存在非零系数。  

**delta_qp**表示量化参数(qp)相对于其先前值得正或负的变化。如果 QP 相对于上一个值没有变化，则 delta_qp = 0。

如果存在残差系数数据，即宏块中有非零系数，如非零 CBP 所示，则传输残差数据(第 5.7.4 节)。  

### 5.7.2 帧内 PCM 模式

### 5.7.3 宏块预测

宏块预测语法元素指示如何对当前宏块执行帧内或帧间预测。sub_mb_pred 用于 8x8 尺寸的 P/B 宏块编码，mb_pred 用于其他情况(图 5.14)。帧内、帧间预测的详细描述，请参见第 6 章。

**I 宏块**：如果预测类型是 4x4 或 8x8，每个 4x4 或 8x8 luma 块的预测模式被传输。如果预测类型是 16x16， 模式会作为 mb_type 中的一部分被传输(第 5.7.1 节)。chroma 预测模式会被传输。第 5.2.5 节详细解释了这些模式如何编码。

**B 宏块，直接 16x16 模式**：没有额外的预测信息被发送；List0/List1 的参考帧标号以及 List0/List1 运动矢量是从先前编码的宏块中派生而来的(第 6 章)。

**P或B宏块，8x8 分区大小**：对于每个 8x8 分区或子宏块，sub_mb_type 被发送来指示子宏块。  

    (a) Direct mode 或者  
    (b) 子宏块分区大小，8x8,8x4,4x8或4x4；以及预测源，List0，List1 和/或 BiPredicted。然后是以下部分或全部元素，取决于 sub_mb_type：  
        (i) 参考图片索引List0和/或List1的索引，每个子宏块的一个索引或一对索引。   
        (ii) List0 和/或 List1 的运动矢量差。  
    
注意，子宏块内的子宏块划分共享同一个参考图像，但子宏块划分都有自己的运动矢量对。  

**所有其他P或B宏块**: 为每个宏块划分发送一下全部或部分，例如，一个 16x16 划分、两个 8x16 划分、两个 16x8 划分：

    (a) List0/List1 的参考图像索引。  
    (b) List0/List1 的运动矢量差。  

将运动矢量差（mvd）添加到预测的运动矢量，以创建每个运动矢量的x和y分量(第 6 章)。  
作为示例，表 5.14 列出了B宏块的类型和预测元素、参考索引和运动矢量差（mvd）对，不包括直接和8的特殊情况×8分区类型。每个分区有一个或两个参考帧，（一个来自 List0,一个来自 List1），以及相应的 mvd 对。  
注意，每个语法元素仅在需要时才会被发送。例如，如果列表中只有一个参考帧，则不必为该列表发送参考索引，因此解码器不期望接收到一个参考帧。

### 5.7.4 残差数据

完整宏块的残差数据(如果存在)，会根据图 5.15 中总结的语法元素发送。图 5.16 给出了残差块的编码顺序。首先，如果对宏块选用帧内 16x16 模式，发送 4x4 块变换的 luma DC 系数。在图 5.16 中，这个可选的第一块标记为`-1`。然后，luma 分量按 8x8 块顺序发送。如果`coded_block_pattern`指示 8x8 块不包含系数(第 5.7.1 节)，那个 block 被绕过了。每个 8x8 luma 块使用四个 4x4 变换处理(图 5.16)或一个 8x8 变换处理(图 5.17)。

在所有编码的 luma 变换系数被发送后，传送两个变换后的色度 DC 系数块，如果`coded_block_pattern`指示它们存在，例如图 5.16 中的 16 和 17 块，图 5.17 中的 4 和 5 块。最后，如果存在，则发送色度 AC 块。如果采样模式是 4:2:0（第 2 章），每个 色度 DC 块包含 2x2 采样点，每个色度 AC 块包含 8x8 采样点。如果是4:2:2 或 4:4:4，尺寸会有变换(第 7 章)。  

每个残差块使用 CAVLC 或 CABAC 编码，CAVLC 和 CABAC 块语法。CAVLC 和 CABAC 块语法在图 5.18 和 5.19 中进行了总结，并在第 7 章中进行了详细描述。  

### 5.7.5 宏块语法示例

