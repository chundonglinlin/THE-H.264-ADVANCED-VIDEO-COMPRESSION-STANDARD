# H.264一致性、传输和许可

## 8.1 引言

第4、5、6 和 7 章介绍了 H.264 高级视频压缩的基本概念，以及使 H.264 编解码器能够高效地对视频进行编码和解码的关键算法。行业标准的目的是实现编码器、比特流和解码器之间的互操作性；即标准使得由一个制造商的编码器编码的比特流可以用不同制造商的解码器解码。H.264/AVC 定义了 Profile 和 Level，以对特殊的编码工具、解码序列所需的计算容量和存储设置操作限制。一致性是用一个理论的“模型”，一个假设的参考解码器来验证的。

H.264/AVC 的实际应用包括传输和/或存储编码视频信息。该标准包含了许多设计的特性，用以支持编码比特流的高效、健壮传输，包括第 5 章介绍的参数集和 NAL 单元，以及本章中描述的特定传输工具。为了支持日益多样化的视频内容和显示类型，包括 SEI 和 VUI 等额外信息，可以与编码视频数据一起传输。

视频编码是一项大业务，世界上许多行业都依赖视频压缩来实现数字媒体产品和服务。在视频编码领域已经有成千上万的专利被公布，H.264/AVC 实现的许可对于商业数字视频应用来说，是一个重要的问题。

## 8.2 遵循标准

H.264/AVC 规定了许多语法选项和解码算法，涵盖了广泛的潜在编码场景。该标准旨在为特定应用支持视频编码，如显示分辨率有限的小型手持设备；最小化计算能力，通过高清晰度解码器与大量的内存和计算资源。该标准描述了可能出现在比特流中的各种语法元素，并明确的规定了为了产生输出视频序列，应如何处理和解码每个语法元素。

知道特定的解码器是否能够处理特定的编码序列，是非常重要的，即解码和显示是否在解码器的能力范围内。这是通过为每个编码序列指定`Profile`和`Level`来实现的。`Profile`在解码器端有算法约束，它决定了解码器应该能够处理哪些解码工具。而`Level`约束了解码端的数据处理和存储，它决定了解码端能够存储、处理和输出到显示器的数据量。通过提取`Profile`和`Level`参数，H.264 解码器可以迅速知道其是否能够解码特定比特流，并确定解码器的能力。

### 8.2.1 Profiles

H.264/AVC 标准制定了许多 Profiles，每个 Profile 指定了H.264 标准中可用的编码工具的子集。Profile 限制了 H.264 解码器所需的算法能力。因此，符合 H.264 的 Main Profile 的解码器只需要支持 Main Profile 中包含的工具；High Profile 解码器需要支持进一步的编码工具；等等。每个 Profile 都只在对一类应用程序有用。例如，基于 Baseline Profile 可用于具有相对较低计算复杂度的低延迟、会话应用，例如视频会议。Main Profile 可适用于基于电视/娱乐应用，例如标准定义电视服务。High Profile 在Main Profile中添加一些工具，这些工具可以提高压缩效率，特别是对于更高空间分辨率的服务，例如高清电视。

#### 8.2.1.1 Baseline、Constrained Baseline、Extended 和 Main Profile

图 8.1 显示了 Baseline、Constrained Baseline、Extended 和 Main Profile 支持的的工具。Baseline Profile最初旨在适用于低复杂度、低延迟的应用，例如会话或移动视频传输。它包括 I 和 P Slice 类型，允许帧内预测和从单一参考帧的运动补偿预测、基本 4x4 整数变换和 CAVLC 熵编码。它还支持三种提高传输效率的工具：FMO、ASO和冗余切片(章节 8.3)。然而，这最后三种工具并没有收到编解码器制造商的欢迎，大多数 H.264/AVC 的实现不支持 FMO、ASO 或 冗余切片。也因为如此，对标准的最近修订包括 Costrained Baseline，Costrained Baseline不再包好这些工具。

扩展的 Profile 是 Baseline Profile的超集，它增加了可能有助于高效网络传输 H.264 数据的更多工具(第 8.3 节)。Main Profile 是 Constrained Baseline Profile 的超集，它增加了可能适用于广播和娱乐应用程序(如数字电视和 DVD 播放)的编码工具，即 CABAC 熵编码和具有双向预测的 B Slices 以及用于隔行视频内容的帧、场编码支持，其中 B Slice 为了提高编码效率，有加权预测。

#### 8.2.1.2 High Profiles

图 8.2 给出了 4 种 High Profile，为了作比较，同时给出了 Main Profile,作为对比。每种 Profile 都会添加编码工具用以，支持更高质量的应用程序--高清、扩展位深度、更高颜色深度，相应的更高的解码复杂度。High Profile 是 Main Profile 的超集，它添加了如下工具：8x8 变换和 8x8 帧内预测（为获得更好的编码性能，特别是在更高的空间分辨率下）、支持频率相关量化器权重的量化器矩阵、将 Cb 和 Cr 的量化器参数分开、支持纯色视频(4:0:0 格式)。High Profile 是的对同一级别使用更高的编码数据速率成为可能(见第 8.2.2 节)。High Profile 对于高清晰度应用尤其有用。

更多的 Profile 添加了更复杂的工具，这些工具对于“专业”应用程序(如内容分发、存档等)可能是必要的或有用的。每个采样掉的最大位数在 High10 Profile 里是 10 bi，在 High44pred Profile 里是 14bit。High422 Profile 支持 4:2:2 视频，即更高的色度分辨率。High444 Profile 将此扩展位 4:4:4 视频，是的色度分量和亮度分量有同样的分辨率，并未每个色度分量添加单独的编码，以及使用预测编码进一步无损编码。

#### 8.2.1.3 Intra Profiles

图 8.3 给出了 Main Profile 和 4 种 Intra Profiles。其中的每个 Profile 都包含了图 8.2 中的 High Profiles 包含的选择工具，但没有帧间编码，即没有 P 或 B Slice。这些 Intranet Profiles 对于诸如视频编辑等应用可能是有用的，这类应用要求对单个帧进行编码，同时要求随机访问，因此不需要帧间编码。

### 8.2.2 Levels

SPS 定义了编码流的 Level，即对H.264/AVC 比特流中的语法元素的值做了约束。Profile 和 Level 的组合限制了解码器的最大计算和内存需求。主要级别限制如下：  
* 最大宏块处理速率(MaxMBPS):宏块的最大数，16x16的亮度和对应的色度，这是解码器必须每秒钟处理的能力。  
* 最大帧大小(MaxFS)：解码帧中的最大宏块数。
* 最大解码图像缓冲区大小(MaxDPB)：在解码端，用于存储解码图像所需要的的最大内存空间。
* 最大视频比特流(MaxBR)：最大编码视频比特率。
* 最大编码图像缓冲区大小(MaxCBP)：解码前用于存储(缓冲)编码数据所需的最大内存空间。
* 垂直运动矢量范围(MaxVmvR):一个垂直运动矢量的最大范围(+/-)。
* 最小压缩比(MinCR):未压缩视频帧与压缩或编码数据大小之间的最小比率。
* 没两个连续宏块的最大运动矢量(MaxMvsPer2Mb):为 Level 3 以上的级别指定，对任意两个连续解码宏块中可能出现的运动矢量(MVx,MVy)数量的限制。

在标准的当前版本中， Level 范围为 1 到 5，中间都是整数级别，如 1.1/1.2/1.3/2.1 等。在特定 Level 上运动的解码器能够处理该级别或该级别以下的任何 Level 约束。例如，Level 2.1 的解码器可以处理 Level 1/1.1/1.2/1.3/2和2.1。图 8.4 为选定的 Level 约束的图像化展示。很明显，这些范围从非常低（适用于具有有限显示分辨率的低复杂度解码器，例如手持设备）到非常高（适用于具有高分辨率显示和大量处理资源的全高清解码器）。

参数 MaxFSB 定义了以宏块为单位的最大解码图像尺寸，这意味着最大的显示分辨率（根据 PAR 不同而不同）。图 8.5 给出了一些示例。例如， Level 1下的 MaxFS 等于 99 个宏块，他对应着 11x9 MB 或 176x144 亮度采样，即 OCIF 分辨率。Level 2.2 和 3下的 MaxFS 等价于 1620 个宏块，它意味着 45x36 MB 或 720x576 亮度采样，625 标准定义。Level 4 和 4.1， MaxFS 等于 8192 宏块，它对应着适应的 120x68 MB 或 1920x1080 亮度采样，标准的 1080 高清定义。请注意，许多其他 PAR 都可能在这些约束条件下。

MaxFS（以宏块为单位的帧大小）和 MaxMBPS(每秒宏块的数目)的组合共同限定了特定分辨率下的帧率。图 8.1 列出了一些示例。Level 1.2 对应着 CIF 分辨率，最大 15fps；或者 QCIF 分辨率、最大 60 fps。Level 4 对应着 1080p 高清分辨率，最大 30fps；或 720p 分辨率，最大 68 fps，等等。

表8.1 Selected formats, frame rates and levels

| Format(luma resolution) | Max frames per second | Level |  
| :-----: | :-----: | :----: |  
| QCIF(176x144) | 15/30 | 1.1b/1.1 |  
| CIF(352x288) | 15/30 | 1.2/1.3,2 |  
| 525 SD(720x480) | 30 | 3 |   
| 625 SD(720x576) | 25 | 3 |  
| 720p HD(1280x720) | 30 | 3.1 |  
| 1080p HD(1920x1080) | 30/60 | 4,4.1/4.2 | 
| 4kx2k(4096x2048) | 30 | 5.1 |  

### 8.2.3 虚拟参考解码器

除了确保解码器能够处理 H.264 流种的语法元素和序列参数外，重要的是确保编码序列“适合”在解码器缓冲和处理能力的限制范围内。这是通过定义一个假想解码器(HRD)来处理的，这是一种虚拟缓冲算法，可用于测试编码比特流的行为及其对真实解码器的影响。H.264 标准的附录 C 规定了假设的参考解码器。

图 8.6 显示了一个典型的 H.264 编解码器。视频帧被编码以产生 H.264 比特流，该比特流在传输之前被缓冲。当对帧 N 进行编码时，编码器缓冲区被 b<sub>n 编码位填充。编码器缓冲区以传输通道的速率(Rc bit/s)清空。这种双重清空发生在解码器处，比特从信道到达并以每秒Rc 比特的速率填充编码图片缓冲区(CPB)。解码器解码帧 N，从 CPB 移除 Bn 位，并将解码帧放置在解码图片缓冲区(DPB)中。然后输出-显示-用于预测以解码更多帧。

HRD(图8.7)是图 8.6 解码侧的模型。在此概念模型中，H.264比特流又假设的流调度器(HSS)以恒定或变化的信道速率输出到 CPB。访问单元(编码图片)从 CPB 中移除并即使解码，即假设它们被即时解码并放置到 DPB 中。

H.264/AVC 标准规定了两种类型的 HRD 一致性，一种用于基本视频编码层(VCL)单元，另一种用于流种的所有视频编码元素。在大多数情况下，兼容解码器必须同时满足这两种类型。必须满足一下条件(除其他条件外，简化标准中的条件)：

1. CPB 不得溢出，即内容不得超过最大 CPB 大小。  
2. CPB 不得下溢，即内容不得达到零。  
3. DPB不得超过其最大尺寸。  

CPB 和 DPB 的最大大小被指定为 Level 限制的一部分，因此 HRD 提供了检查和强制执行 Level 限制的机制。HRD 的操作可以用一些例子来说明。

示例1：典型的 HRD 操作
Video Frame Rate: 5 frames per second  
Channel bit rate: 5000 bits per second: constant bit rate  
Initial removal delay: 0.8 seconds: see below  
Maximum CPB  size : 6000 bits

比特流由一系列具有以下编码大小的访问单元组成(表8.2)。

图 8.8 显示了编码器输出缓冲区的行为。帧 0 在时间 0 处被解码并添加到缓冲区，随后的每一帧以 0.2 秒的间隔添加。同时，通道以每秒 5000 位的恒定速率清空缓冲区。大于(比特率/帧率) = 1000 位的帧导致缓冲区填满；小于 1000 位的帧会导致缓冲区清空。 

编码器缓冲区的行为类似于“泄漏桶”：根据每个访问单元的编码大小以可变速率填充，并以恒定速率清空或泄漏信道的比特率。  

相应的解码器 CPB 行为如图8.9 所示。初始 CPB 移除延迟是必要的，以允许在解码帧之前接收足够的数据，在本示例中为 0.8 秒。在解码帧 0 从缓冲器中移除之前的初始延迟期间，CPB 以恒定信道速率填充。在解码前 5 帧时，CPB 接近下溢状态。回到图 8.8，这对应于编码器处初始增加的缓冲级别。事实上，如果编码器缓冲区占用超时(CPB 初始移除延迟 * 比特率) = 4000 位，CPB 将下溢。CPB表现出与编码器缓冲器相反的行为–大帧（>1000位）导致CPB电平降低，小帧（<1000位）导致CPB电平升高。

### 8.2.4 一致性测试

H.264/AVC 的附录C 描述了如何使用 HRD 测试一致性。H.264 中规定了一致性测试方法。本建议描述了一系列旨在验证编码比特流和视频解码器是否符号 H.264/AVC 要求的测试。

#### 8.2.4.1 测试位流

比特流一致性(即编码视频比特流是否实际符合 H.264/AVC)，可使用联合模型参考软件解码器进行测试(图 8.14)。待测试的比特流由参考解码器解码以产生输出视频序列。如果语法、HRD行为等有问题，参考解码器应使用错误消息指示。无错误操作意味着但不能保证一致性。

#### 8.2.4.2 测试解码器

解码器应该能够将任何适用于 Profile 和 Level 限制的比特流(第 8.2.1 节)。可以通过解码一组一致性测试比特流来检查解码器是否符合 H.264/AVC(图 8.15)。一致性解码器应产生正确的视频序列，帧/场顺序正确，输出帧之间具有必要的时序关系。一致性比特流在一些列级别上可用于 H.264/AVC Profile 文件中的每一个，并且可以从 ITU-T 或以草稿形式以 JVT 存档。

#### 8.2.4.2 测试编码器

没有测试编码器一致性的具体方法，因为严格来说 H.264/AVC 没有定义或指定视频编码器。然而，声称符号 H.264/AVC 的编码器应始终产生满足 H.264/AVC 附录 C 的一致性要求和附录 C 中定义的测试程序的编码器比特流。

## 8.3 支持传输的 H.264 编码工具

H.264/AVC 可能是最有名的高效视频压缩格式。然而，认识到 H.264 的大多数应用涉及压缩比特流的通信或存储这一事实，该标准规定了旨在支持高效和健壮传输的许多特征或工具。Baseline 和 Extended Profiles 支持 冗余 slices、任意 slice 顺序和灵活宏块顺序；Extended Profile 支持数据分区slice、SI slice 和 SP slice。值得注意的是，这些功能尚未被商用H.264/AVC编解码器广泛采用，大多数商用H.264/AVC编解码器倾向于使用 Constrained Baseline、Main 和 High Profiles。

### 8.3.1 冗余 Slices

标记为"redundant"的 slice 包含编码帧的部分或全部的冗余表示。在正常操作中，解码器从

## 8.4 H.264 数据传输

## 8.5 补充信息

## 8.6 许可 H.264/AVC

## 8.7 总结

H.264/AVC 的许多功能超出了基本的视频压缩，涵盖了编码器/解码器互操作性、解码器计算能力、健壮的传输和存储以及显示参数等方面。互操作性通过使用 Profile、定义的编码工具子集(可能对特定类别的应用有用)、以及解码器的计算和存储要求的Profile、limit来支持，并通过使用假设参考解码器的一致性测试来检查。可靠的传输和存储是 H.264 比特流的基于分组的结构和独立参数集中关键参数的信令所固有的。可选的编码工具使进一步提高传输可靠性成为可能，尽管其中许多工具尚未在商用 H.264 编解码器中广泛采用。使用通用传输协议和文件格式传输和存储 H.264 内容的方法的定义，有助于该标准的快速和广泛采用。类似的，主要专利持有人提前公布许多条款有助于简化 H.264/AVC 在商业、大规模消费者应用中的采用。















