# H.264 是什么

## 4.1 引言

本章从多个角度介绍 H.264。首先，我们要解决一个问题---什么是H.264？从不同的角度看，H.264 可能意味着不同的事情。它是工业标准，定义了压缩视频数据的格式，提供了一套工具，用各种方式压缩和传输视觉信息。这是一些列视频压缩标准化方法发展的一个阶段。我们看一下 H264 编码器和解码器中执行的基本操作。我们更深入地了解 H.264，检查 H.264 标准中包含了什么，主要的工具和组件集，呈现了 H.264 压缩的概要语法和格式，更详细地查看通过典型 H.264 编解码的数据流。最后，我们讨论一些实际问题---H.264在工作中有多出色，H.264在真实应用程序中使用的。

## 4.2 H.264 是什么

H.264/AVC 是一种视频编码的工业标准，它也是编码视频的流行格式，是一套视频压缩工具，也是不断发展的数字视频通信领域的舞台。本节介绍 H.264/AVC 的一些“视图”。

### 4.2.1 视频压缩格式

H.264 是一种用于视频压缩的方法和格式，是将数字视频转换为存储或传输时占用较少容量的格式的过程。视频压缩或视频编码是数字电视、DVD视频、移动电视、视频会议和互联网视频流等应用的关键技术。标准化的视频压缩使得来自不同制造商的产品(如编码器、解码器和存储介质)能够相互操作。编码器将视频转换为压缩格式，解码器将压缩视频转换为未压缩格式。

在诸如远程监控这种典型的 H.264 应用中，使用 H.264 对来自摄像头的视频进行编码或传输，以产生 H.264 比特流。它通过网络发送到解码端，解码器重建原视频，如图 1.1 所示。图 1.1 显示了源视频(未压缩的视频材料)是如何由编码器编码并存储在服务器上的。压缩视频，一个比特序列，被传输到一个或多个客户端。在双向对话视频应用中，如视频会议,Skype 视频等，系统的两端需要一个编码器来压缩来自本地摄像头的视频，需要一个解码器来解压来自远程摄像机的视频，如图 1.2 所示。

### 4.2.2 一个工业标准

H.264：高级视频编码是由国际电联(国际电信联盟)和ISO/IEC(国际标准化组织/国际电工委员会)两个国际标准机构共同出版的文件。它定义了压缩视频的格式和语法，以及解码该语法以产生可显示视频序列的方法。标准文档并没有指定如何对数字视频进行编码--这由视频编码器的制造商负责--但实际上编码器是解码过程的镜像。图 4.1 给出了编码和解码过程，并突出显示了 H.264 标准所涵盖的部分。

H.264/AVC 标准于 2003 年首次发布，此后出版了几次修订和更新。它建立在早期标准(如 MPEG-2和 MPEG-4)的概念之上，具有更好的压缩效率，即更好的压缩视频质量，以及在压缩、传输和存储视频方面的更大灵活性。

### 4.2.3 视频压缩的工具集

H.264/AVC 描述了一组用于视频压缩的工具和方法。该标准规定了用这些工具编码的视频如何表示和解码。视频编码器可以选择使用哪些工具以及如何将他们应用于当前视频序列，但有一些限制。兼容 H.264 的解码器必须能够使用定义的工具子集，称为配置文件。

### 4.2.4 更好的视频压缩

H.264标准之所以得到如此广泛的应用，是因为与早期标准相比，它的性能得到了提高。大众市场应用(如数字电视和 DVD 视频上的消费视频存储)的基准是早期的 MPEG-2 标准。H.24 提供了比  MPEG-2 更好的压缩性能。在相同的视频分辨率和图像质量下，使用 H.264 可以将视频压缩成比使用 MPEG-2 少很多的比特数。这意味着，通过使用 H.264 格式，可以将更多的视频存储在磁盘上或通过广播信道传输。

## 4.3 H.264 codec 如何工作的

H.264 视频编码器执行预测、转换和编码处理(如图 4.1),以生成压缩的 H.264 比特流。H.264 视频解码器执行解码、逆变换和重构的处理以产生解码的视频序列。如图 4.2 所示，原始视频帧或场的序列被编码成 H.264 格式，一系列的比特流代表压缩的视频数据。该压缩比特流被存储或传输，并且可以被解码以重构视频序列。通常，解码版本与原始序列不相同，因为 H.264 是有损压缩格式，即在压缩期间丢失一些图片质量。

被编码的帧或场(如图 4.3 中的 Frame A)，由与 H.264 兼容的视频编码器处理。除了将帧作为编码比特流或编码文件的一部分进行编码和发送外，编码器也会重构帧，即创建最终由解码器产生的解码帧 A 的副本。该重建副本可以存储在编码图片缓冲器 CPB 中，并且在未来帧的编码期间使用。解码器接受编码比特流并解码帧用于显示或后处理。同时，解码器可能存在解码帧的副本在解码图片缓冲区 DPB 中，以在未来帧的解码时使用。

图4.4（编码器）和图4.5（解码器）更详细地显示了典型 H.264 编解码器的结构。数据的处理是以宏块为单位进行的，对应的显示像素是 16x16。在编码器中，生成预测宏块，并从当前宏块中减去预测宏块以形成残差宏块，它会被变换、量化和编码。同时，量化数据被反量化和逆变换，并被添加到预测宏块中以重构帧的编码版本，该编码版本被存储以供以后的预测。在解码端宏块被解码、反量化、逆变换形成解码后的残差宏块。解码器生成在编码端创建的相同预测，并将其添加残差中以产生解码宏块。

### 4.3.1 编码器处理

#### 4.3.1.1 预测

编码器基于先前编码的数据，形成当前宏块的预测，或者来自使用**帧内**预测的当前帧，或者来自已经使用**帧间**预测编码和发送的其他帧。编码器从当前宏块中减去预测以形成**残差**(如图 4.6)。

H.264 支持的预测方法比以前的标准更加灵活，能够实现准确的预测，从而实现高效的视频压缩。帧内预测使用 16x16 和 4x4 块带下，从同一帧内的周围、先前编码的像素预测宏块（如图 4.7）。

将先前编码的相邻像素的值外推以形成当前宏块的预测。图 4.8 给出一个示例。16x16 形成预测块，这是原始宏块的近似值。从原始宏观减去预测产生剩余块(同样是包含 16x16 样本)。

帧间预测使用的块大小范围从 16x16 到 4x4 从先前编码帧中的相似区域预测当前帧中的像素（如图 4.9）。这些先前编码的帧，按照显示顺序可能在当前帧之前或之后。在图 4.9 所示的示例中，当前帧中的宏块1（MB1）是从过去帧中最近的帧中 16x16 区域预测来的，MB2是由两个先前编码的帧预测。上方的 8x16 块是从过去帧预测来的，下方的 8x16 是从未来帧预测来的。

图 4.10 显示了一个原始宏块的例子，以及从上一帧的预测。在这个例子中， 16x16 预测块与当前宏块匹配良好。残差宏观中的值大多接近于零。

#### 4.3.1.2 变换与量化

残差样本块的变换使用 4x4 或 8x8 整数变换，离散余弦变换(DCT)的近似形式。变换输出一组**系数**，每个系数都是标准基模式的加权值。当组合时，加权的基模式重建残差样本块(如图 4.11)。

将变换的输出(变换系数的块)量化，即每个系数除以整数值。量化根据量化参数(QP)降低变换系数的精读。例如，图 4.12 中的原始系数值除以 QP，并四舍五入到最接近的整数。通常，量化后的结果块，其中大部分或全部系数为零，少数系数为非零。将 QP 设置为更高的值意味着更多的系数被设置为零，从而导致以较差的解码图像质量为代价的高压缩。将 QP 设置为较小值意味着在量化之后保留更多的非零系数，从而在解码器处产生更好的图像质量，但压缩率会变低（如图 4.13）。

#### 4.3.1.3 比特流编码

视频编码过程产生必须编码以形成压缩比特流的许多值。这些值包括：

* 量化的变换系数  
* 使解码器能够重新创建预测的信息  
* 有关压缩数据的结构和编码期间使用的压缩工具的信息  
* 有关完整视频序列的信息  

这些语法元素及其值，使用可变长编码和/或算数编码，转换为二进制代码。这些编码方法中的每一种都产生一种高效、紧凑的二进制信息表示。然后可以存储和/或传输编码比特流。

### 4.3.2 解码过程

#### 4.3.2.1 比特流解码

视频解码器接受压缩的 H.264 码流，对每个语法元素进行解码并提取上述信息，即量化变换系数、预测信息等。然后使用该信息来反转编码过程并重新创建编码视频图像序列。

#### 4.3.2.2 反量化及逆变换

量化的变换系数被反量化。每个系数诚意整数以恢复其原始比例。在 图 4.14 的例子中，量化系数分别成衣 QP 或步长 8。反量化后的系数与原始数据近似但不相同。

反变换结合标准基模式，通过重新缩放的系数加权，以重新创建每个残差数据块。图 4.15 显示了逆 DCT 或整数变换如何通过根据一个系数值加权每个基模式并加权基模式来创建图像块。这些块组合在一起以形成残差宏块。在图 4.16 中，使用 10 或 20 的量化步长重新缩放图 4.13 的量化系数，并进行逆变换。重建的块与图 4.13 的原始块相似但不完全相同。这种差异或损失是由于前向量化过程造成的。较大的量化步长倾向于在原始块和重构块之间产生较大的差异。

#### 4.3.2.3 重建

对于每个宏块，解码器形成解码器形成与编码器使用来自先前解码帧的帧间预测或来自当前帧中先前解码样本的帧内预测创建的宏块相同的预测。解码器将所述预测添加到所述解码残差以重构解码宏块，所述解码宏块随后可被显示为视频帧的一部分(如图 4.17)。

## 4.4 H.264/AVC 标准

H.264 标准的当前版本是一个超过 550 页的文档。它包含规范性内容、H.264编解码器必须遵守的基本说明、以及非强制性的信息性内容和指南，其组织结构如表 4.1 所示。请注意，随着本标准的修订或更新版本的发布，可能会添加更多的章节或附录。

符合 H.264 标准的位流（编码视频序列）应符合语法定义，并根据标准第 7 章中描述的语义构造语法元素。H.264 解码器应当遵守标准第 9 章中的解析处理以及从比特流中提取的语法元素，并且根据标准第 8 章中描述的解码处理来解码这些语法元素，以便创建解码的视频序列。

## 4.5 H.264 Profile and Levels

H.264支持一系列“工具”。这些工具是用于编码和解码视频及相关操作的算法或过程。这些工具对于 H.264 的任何实现都是必不可少，比如最基础的 4x4 变换，可选或可换的工具，如 CABAC 或 CAVLC 熵编码，用于特定应用或场景的工具，如可支持流视频的 SI/SP 工具，以及与视频编码不直接相关的工具，如 VUI 和 SEI 消息。

编码器在选择和使用标准中定义的工具时，具有相当大的灵活性。解码器可能使用非常有限的一组工具进行操作，例如，如果仅需要解码使用工具子集的比特流。H.264 Profiles 定义了一个特定的工具子集。符合特定 profile 的H.264比特流只能包含使用 profile 内的一些货所有工具编码的视频；与 profile 兼容的解码器必须能够使用 profile 中的每个工具进行解码。因此，profile 可以看出解码器所需能力的约束。Main profile 可能是目前应用最广泛的，它在提升压缩性能和计算复杂度直接提供了很好的折中的工具。被约束的 Baseline Profile 是 Main Profile 的一个子集，它在低复杂度、低延迟应用中非常流行。

第二个约束是解码器可以处理的数据量，这可能受到解码器的处理速度、存储器容量和显示大小的限制。H.264/AVC Level 指定了解码视频序列所需的帧大小、处理速度(每秒可解码的帧或块的树木)和工作存储器的上限。特定解码器只能将 H.264 比特流解码到 Profile 和 Level 的特定组合。

## 4.6 H.264  语法

H.264 为表示压缩视频和相关信息提供了一种明确定义的格式或语法。图 4.19 显示了 H.264 语法结构的概述。

在最顶层，H.264 序列由一系列分组或网络适配层单元、NAL 单元或 NALU 组成。这些可以包括含有关键参数的参数集，解码器使用这些关键参数来正确解码适配数据和片段，这些片段是编码视频帧或视频帧的一部分。

在下一级，Slice 表示编码视频帧的全部或部分，它由多个编码宏块组成，每个宏块包含对应于一帧中显示像素的 16x16 块。在图 4.19 的最低层次，宏块包含描述用于编码宏块的方法的特定选择的类型信息、诸如编码运动矢量或帧内预测模式信息和编码残差数据的预测信息。

## 4.7 H.264 应用

### 4.7.1 性能

与以前的标准相比，H.264最大的优势可能是它的压缩性能。与MPEG-2和 MPEG-4 等标准相比，H.264可以提供：

* 在相同的压缩比特率下获得更好的图像质量
* 相同图像质量下的较低压缩比特率

例如，一张单层 DVD 可以存储大约两个小时长的 MPEG-2 格式电影。使用 H.264，应该可以在同一个磁盘上存储四小时或更多相似质量的电影，即相同质量低下有更低的比特流。或者，与 MPEG-2 和 MPEG-4 视频格式相比，H.264 压缩格式可以在相同比特率下提供更好的质量(如图 4.23)所示。

H.264压缩性能的提高是以更高的计算成本为代价的。与早期的压缩方法相比，H.264更加复杂，这意味着压缩和解压缩H.264视频可能需要更大的处理能力。

### 4.7.2 应用

除了其改进的压缩性能，H.264在压缩选项和传输支持方面提供了更大的灵活性。H.264编码器可以从多种压缩工具中进行选择，使其适用于从低比特率、低延迟移动传输到高清晰度消费电视到专业电视制作的各种应用。该标准提供了对传输或存储的集成支持，包括打包的压缩格式和有助于将传输错误的影响降至最低的功能。

H.264/AVC 已被用于越来越多的应用，包括：

* DVD（蓝光）
* 视频会议
* 电话广播

## 4.8 总结

H.264 高级视频压缩是视频编码的行业标准，它定义了压缩视频的格式和语法以及解码该语法的方法。它提供了一组工具或算法，可用于为各种应用提供高效、灵活和健壮的视频压缩，从低复杂度、低比特率的移动视频应用到高清广播服务。后面的章节将详细介绍 H.264 的工具、特性和性能。
