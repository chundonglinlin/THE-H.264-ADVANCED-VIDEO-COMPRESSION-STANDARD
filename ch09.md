# H.264 性能

## 9.1 引言

H.264/AVC 被广泛采用的背后驱动力是，它比旧格式（如 MPEG-2 和 MPEG-4）具有更加显著的压缩性能。然而，从 H.264 编解码器中获取最佳性能，并不是一项简单的任务。首先，尽管 H.264/AVC 是一个行业标准，但 H.264 编解码的实际实现之间存在很大的差异，编码性能也有相应的变换。其次，H.264 支持的大量编码选项在压缩和计算之间会有一个权衡问题。从 H.264 编解码器获得最佳可能的压缩性能，可能导致实际应用会产生高昂的计算成本。

要了解 H.264/AVC 的性能权衡和功能，最好的方法可能就是做实验。幸运的是，有许多公共域实现使者成为可能。负责开发和维护标准的联合视频开发组发布了H.264/AVC（联合模型（JM）编解码器）的参考软件实现。JM 的目标是全面、准确地实现H.264的所有功能。它不适合于实际的实时编码应用，但却是测试H.264潜力和检查编解码器与位流之间互操作性的有用参考工具。使用JM和/或其他H.264实现，可以对视频序列进行编码和解码，并测试标准的各种工具和特性的效果。

H.264 的大多数应用都对编码序列的比特率有严格的限制。例如，广播频道具有以bps为单位的固定容量；网络流媒体可以处理可变比特率，但也仅限于上限和下限内；视频通话这样的会话应用需要最小的端延迟；等等。基于这些原因，H.264的实际实现通常需要码率控制算法来将编码比特率限制在一定的限制内。

从 H.264/AVC 编解码器获得最佳性能，通常涉及为每个视频流里的每个编码单元，选择最佳编码选项或者编码模式。模式选择过程对于获得良好的压缩性能至关重要。也是因为这个原因，关于（a）有效的模式选择--意味着良好的率失真性能，和（b）计算复杂度的之间，再寻找两者的平衡方面，已经有大量的研究。

## 9.2 H.264 实验

### 9.2.1 JM 参考软件

#### 9.2.1.1 概述

联合视频团队（JVT）是负责研发和维护 H.264/AVC 的组织，它发布了标准的一个参考实现，全部实现使用 C 程序，成为联合模型(JM)。在撰写本文时，最新版本(16.0) 可从[JM](http://iphome.hhi.de/suehring/tml/)下载。较久版本的软件发布为 ITU-T 标准 H.264。JM 软件手册详细描述了软件的操作和参数。JM 中许多编码算法的详细描述可以在 2005 年发布的 JVT 文档中找到。

JM 软件由一个编码器(lencod)和一个解码器(ldecod)组成，前者将源视频文件编码为 H.264 文件，后者将 H.264 文件解码为解码的视频文件。编码器和解码器分别由一个默认名称为 encoder.cfg 和 decoder.cfg 的参数文件控制。编码器创建重构的视频文件，即解码视频文件的副本，并且可以选择性地生成一个跟踪文件，记录编码序列的每个语法元素(图 9.1)。

#### 9.2.1.2 文件格式

源视频文件、重建视频文件和解码的视频文件采用原始的 YCbCr 格式。其中，luma、Cb 和 Cr样本存储在视频文件中，没有头信息和其他信息。支持各种采样格式，但默认是平面顺序，帧的每个组件以光栅扫描顺序存储，从帧 0 开始(如图 9.2)。

#### 9.2.1.3 基础操作

JM 软件解压并编译到表 9.1 所示的目录结构中。

解码的 QCIF 文件的视觉质量可以使用一个 YUV Viewer，一个可以播放 YUV 文件的程序。许多 YUV Viewer 查看器可供下载。注意重建文件，在本例中的 rec.qcif 和 解码文件 dec.qcif 是相同的。图 9.5 显示了每个 QCIF 文件的第 56 帧。注意：

(i) 由于编码期间的量化，解码帧/重构帧具有更少的细节。较低的 QP 会提升解码质量，代价是比特率较高。  
(ii) 解码帧和重建帧是相同的。

因此，实际上没有必要运行解码器(ldecod)来查看解码质量，因为编码器会生成解码视频文件以及分析编码性能所需的所有必要统计信息，例如比特率和 PSNR。

#### 9.2.1.4 高级操作

`encoder.cfg`中的大量可选参数为用户提供了对 JM 编码器操作的详细控制。其主要部分对编码器操作的影响如下(表 9.2)。请注意，Baseline 配置文件中不存在有些部分，例如 B Slice 参数。因为 JM 软件仍在继续开发，因此这些部分及其内容可能会更改。

## 9.4 码率控制

当编码器编码宏块时，生成的比特数并不是固定的。例如，图 9.20 给出了编码`Foreman`帧为 P Slice 时，每个宏块的位数。较浅的块包含更多的比特，较深的块包含更少的位。通常，更多比特用来编码包含显著运动和细节的 MB，因为这些 MB 包含非零运动矢量和非零变换系数。

类似的方式，每个编码帧的比特数不是恒定的。如果所有编码参数保持不变，则运动和细节的变化导致比特数变化。例如，参见图 9.7 中的比特率图。

H.264/AVC 的实际应用需要恒定的比特流输出，或者至少是一个受限的比特率输出。表 9.7 给出了一个例子。

典型的编码场景如图 8.6 (第 8 章)所示。编码器输出缓冲区对编码比特率有“平滑”或平均效果。然而，HRD 的限制(第 8 章)意味着：除非解码器能够处理任意长的解码延迟，否则总是需要控制或管理编码比特率。

控制输出比特率通常是通过测量速率和/或编码器缓冲区满溢程度，并将其反馈给控制编码器来实现(如图 9.21)。许多编码器参数可以影响输出比特率，例如 Slice 类型、运动搜索范围、模式选择算法等。但码率控制最有效的参数是量化参数(QP)。

控制比特率的一种方法是，通过测量输出比特率并将其反馈给控制 QP，尝试并强制每个编码帧具有恒定的比特数。增大 QP 降低编码比特率，减小 QP 增加编码比特率。然而，这种方法是有问题的，因为(i)它没有考虑到编码 I/P/B 不同的 Slice 会产生不同的比特数(图 9.8)；(ii)当编码器为尝试并保持比特率时，它会快速的增加或减少 QP，这将导致图像质量变化剧烈。 

一个更灵活的方法如图 9.22 所示。可用信道比特率(以bits/s为单位)，被用来决定一个 GOP 的目标比特数，通常 I Slice 后跟着多个 P 和/或 B Slice。然后将可用于 GOP 的bits 分配给 I/P/B Slice，分配多少会根据 Slice 类型而改变。I Slice 通常会被分配大多数比特，因为帧内预测往往比帧间预测效率低，然后是 P Slice，再然后是 B Slice。每个 Slice 中，一定数量的比特被分配到每个宏块。码率控制算法之后尝试控制编码器以产生目标位数。

### 9.4.1 JM 参考编码器中的码率控制

#### 9.4.1.1 GOP 级别的码率控制

#### 9.4.1.2 帧级别和宏块级别的码率控制

## 9.5 模式选择

H.264/AVC 编码器在编码宏块时，会从许多不同的选项或模式中进行选择。图 9.26 显示了宏块的主要预测选择，更详细介绍，参见第 5 章和第 6 章。其中包括：

* 'Skip'模式，不发送此宏块的任何信息。  
* 4 种 16x16 帧内预测模式。
* 9 种 4x4 帧内预测模式，每个 4x4 块有不同的选择模式。
* 16x16 帧间模式，从一个(P 宏块)或两个(B 宏块)列表中的参考图像进行预测。
* 8x16 帧间模式：根据上述多个参考图片进行预测，每个分区可选择不同的参考图片。
* 16x8 帧间模式：参考图片的选择如上所述。
* 8x8 帧间模式，参考图片选择如上所述。每个分块进一步划分，8x8 划分成 8x4,4x8，或4x4子宏块分区。

除了预测模式的选择外，编码器也可以选择改变量化参数(QP)。对于每种帧间模式，编码器具有非常广泛的运动矢量的选择；等等。对于宏块编码，有大量的选项可供选择。每个编码模式，即编码参数的每个组合，将倾向于产生不同数量的编码比特，范围从非常低(P-Skip 或 B-Skip)到高(帧内)以及不同的失真或重构质量。

视频编码器的目标是最小化编码比特率和最大化解码质量，或者说最小化解码失真。然后，为每个宏块选择编码模式来达到目的，是非常困难的。因为(a)编码参数的大量可能组合(b)在最小化比特率和最小化失真之间决定了"最佳"平衡问题。

### 9.5.1 率失真优化模式选择

率失真优化(RDO)模式选择是一种基于率失真代价，为每个宏块选择编码模式的技术。在其最流行的公式中，比特率代价 R 和失真代价 D 被组合成单个代价J（9.3）:  J = D + λR

RDO 模式选择算法试图找到一种使联合代价 J 最小的模式。率失真之间的平衡是通过拉格朗日乘数因子 λ 控制平衡。较小的 λ 将更加强调最小化 D，允许更高的码率；而一个更大的 λ 将倾向于以更高的失真为代价最小化 R。对于特定的序列，选择最好的 λ 是一个高度复杂的问题。幸运的是，近似的经验已经被发现了；在实际的模式选择场景中，它提供了 λ 的一个有效选择。











