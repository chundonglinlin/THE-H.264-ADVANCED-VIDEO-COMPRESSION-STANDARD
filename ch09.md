# H.264 性能

## 9.1 引言

H.264/AVC 被广泛采用的背后驱动力是，它比旧格式（如 MPEG-2 和 MPEG-4）具有更加显著的压缩性能。然而，从 H.264 编解码器中获取最佳性能，并不是一项简单的任务。首先，尽管 H.264/AVC 是一个行业标准，但 H.264 编解码的实际实现之间存在很大的差异，编码性能也有相应的变换。其次，H.264 支持的大量编码选项在压缩和计算之间会有一个权衡问题。从 H.264 编解码器获得最佳可能的压缩性能，可能导致实际应用会产生高昂的计算成本。

要了解 H.264/AVC 的性能权衡和功能，最好的方法可能就是做实验。幸运的是，有许多公共域实现使者成为可能。负责开发和维护标准的联合视频开发组发布了H.264/AVC（联合模型（JM）编解码器）的参考软件实现。JM 的目标是全面、准确地实现H.264的所有功能。它不适合于实际的实时编码应用，但却是测试H.264潜力和检查编解码器与位流之间互操作性的有用参考工具。使用JM和/或其他H.264实现，可以对视频序列进行编码和解码，并测试标准的各种工具和特性的效果。

H.264 的大多数应用都对编码序列的比特率有严格的限制。例如，广播频道具有以bps为单位的固定容量；网络流媒体可以处理可变比特率，但也仅限于上限和下限内；视频通话这样的会话应用需要最小的端延迟；等等。基于这些原因，H.264的实际实现通常需要码率控制算法来将编码比特率限制在一定的限制内。

从 H.264/AVC 编解码器获得最佳性能，通常涉及为每个视频流里的每个编码单元，选择最佳编码选项或者编码模式。模式选择过程对于获得良好的压缩性能至关重要。也是因为这个原因，关于（a）有效的模式选择--意味着良好的率失真性能，和（b）计算复杂度的之间，再寻找两者的平衡方面，已经有大量的研究。

## 9.2 H.264 实验

### 9.2.1 JM 参考软件

#### 9.2.1.1 概述

联合视频团队（JVT）是负责研发和维护 H.264/AVC 的组织，它发布了标准的一个参考实现，全部实现使用 C 程序，成为联合模型(JM)。在撰写本文时，最新版本(16.0) 可从[JM](http://iphome.hhi.de/suehring/tml/)下载。较久版本的软件发布为 ITU-T 标准 H.264。JM 软件手册详细描述了软件的操作和参数。JM 中许多编码算法的详细描述可以在 2005 年发布的 JVT 文档中找到。

JM 软件由一个编码器(lencod)和一个解码器(ldecod)组成，前者将源视频文件编码为 H.264 文件，后者将 H.264 文件解码为解码的视频文件。编码器和解码器分别由一个默认名称为 encoder.cfg 和 decoder.cfg 的参数文件控制。编码器创建重构的视频文件，即解码视频文件的副本，并且可以选择性地生成一个跟踪文件，记录编码序列的每个语法元素(图 9.1)。

#### 9.2.1.2 文件格式

源视频文件、重建视频文件和解码的视频文件采用原始的 YCbCr 格式。其中，luma、Cb 和 Cr样本存储在视频文件中，没有头信息和其他信息。支持各种采样格式，但默认是平面顺序，帧的每个组件以光栅扫描顺序存储，从帧 0 开始(如图 9.2)。

#### 9.2.1.3 基础操作

JM 软件解压并编译到表 9.1 所示的目录结构中。

解码的 QCIF 文件的视觉质量可以使用一个 YUV Viewer，一个可以播放 YUV 文件的程序。许多 YUV Viewer 查看器可供下载。注意重建文件，在本例中的 rec.qcif 和 解码文件 dec.qcif 是相同的。图 9.5 显示了每个 QCIF 文件的第 56 帧。注意：

(i) 由于编码期间的量化，解码帧/重构帧具有更少的细节。较低的 QP 会提升解码质量，代价是比特率较高。  
(ii) 解码帧和重建帧是相同的。

因此，实际上没有必要运行解码器(ldecod)来查看解码质量，因为编码器会生成解码视频文件以及分析编码性能所需的所有必要统计信息，例如比特率和 PSNR。

#### 9.2.1.4 高级操作

`encoder.cfg`中的大量可选参数为用户提供了对 JM 编码器操作的详细控制。其主要部分对编码器操作的影响如下(表 9.2)。请注意，Baseline 配置文件中不存在有些部分，例如 B Slice 参数。因为 JM 软件仍在继续开发，因此这些部分及其内容可能会更改。

## 9.4 码率控制

当编码器编码宏块时，生成的比特数并不是固定的。例如，图 9.20 给出了编码`Foreman`帧为 P Slice 时，每个宏块的位数。较浅的块包含更多的比特，较深的块包含更少的位。通常，更多比特用来编码包含显著运动和细节的 MB，因为这些 MB 包含非零运动矢量和非零变换系数。

类似的方式，每个编码帧的比特数不是恒定的。如果所有编码参数保持不变，则运动和细节的变化导致比特数变化。例如，参见图 9.7 中的比特率图。

H.264/AVC 的实际应用需要恒定的比特流输出，或者至少是一个受限的比特率输出。表 9.7 给出了一个例子。

典型的编码场景如图 8.6 (第 8 章)所示。编码器输出缓冲区对编码比特率有“平滑”或平均效果。然而，HRD 的限制(第 8 章)意味着：除非解码器能够处理任意长的解码延迟，否则总是需要控制或管理编码比特率。

控制输出比特率通常是通过测量速率和/或编码器缓冲区满溢程度，并将其反馈给控制编码器来实现(如图 9.21)。许多编码器参数可以影响输出比特率，例如 Slice 类型、运动搜索范围、模式选择算法等。但码率控制最有效的参数是量化参数(QP)。

控制比特率的一种方法是，通过测量输出比特率并将其反馈给控制 QP，尝试并强制每个编码帧具有恒定的比特数。增大 QP 降低编码比特率，减小 QP 增加编码比特率。然而，这种方法是有问题的，因为(i)它没有考虑到编码 I/P/B 不同的 Slice 会产生不同的比特数(图 9.8)；(ii)当编码器为尝试并保持比特率时，它会快速的增加或减少 QP，这将导致图像质量变化剧烈。 

一个更灵活的方法如图 9.22 所示。可用信道比特率(以bits/s为单位)，被用来决定一个 GOP 的目标比特数，通常 I Slice 后跟着多个 P 和/或 B Slice。然后将可用于 GOP 的bits 分配给 I/P/B Slice，分配多少会根据 Slice 类型而改变。I Slice 通常会被分配大多数比特，因为帧内预测往往比帧间预测效率低，然后是 P Slice，再然后是 B Slice。每个 Slice 中，一定数量的比特被分配到每个宏块。码率控制算法之后尝试控制编码器以产生目标位数。

### 9.4.1 JM 参考编码器中的码率控制

JM 参考编码器中采用的速率控制算法在 [iv] 和 [ix] 中以基本形式进行了描述。提出了各种修改，其中一些修改已纳入参考软件[x] 的后续版本中。速率控制算法试图:i. 在编码期间保持目标编码比特率；ii. 最小化解码视频序列中明显质量变化。它在以下约束条件下运行：

可用比特率 R：每秒的位数可以是恒定的，也可以是可变的。  
缓冲区大小：编码器输出缓冲区和解码器输入缓冲区的大小。  
视频统计： 输入视频信号中的运动量和细节，通常是变化的。  

一般做法如下：  

1. 基于以下内容为编码单元分配目标位数：a. 考虑到目标比特率和到目前为止产生的实际比特率，可用比特率。b. 缓冲区内容。c. 编码单元对未来编码决策的重要性，例如，它是用作进一步预测帧参考的片段的一部分。
2. 控制QP以尽可能接近目标位数。
3. 根据输入和编码序列的实际统计信息更新速率控制算法的参数。

该方法应用于从 GOP 到编码图片的各个级别，并且可选地应用于单个宏块或宏块序列的级别。控制速率的最低级别被描述为基本单元，可以是单个宏块、多个连续宏块或整个编码帧。

#### 9.4.1.1 GOP 级别的码率控制

假设 GOP 结构由一个 I slice 和一个 P slice 和/或 B slice 组成。

1. 计算可用于编码 GOP 的位数，基于:a. 可用比特率，序列中的常数或变量，u。b. 帧率，F。c. GOP中的帧数，N。d. 编码器输出缓冲区的大小和占用率，B。
2. 根据一下公式计算 GOP 的起始 QP:a. 分配给前一个GOP中的帧的qp。b. 以前和当前GOP的目标比特率。

为了保持合理一致的帧质量，QP在GOP之间不应变化太大。

#### 9.4.1.2 帧级别和宏块级别的码率控制

如果基本单元是完整的编码帧，则以下步骤每帧应用一次，如果基本单元小于一帧，则执行多次。

## 9.5 模式选择

H.264/AVC 编码器在编码宏块时，会从许多不同的选项或模式中进行选择。图 9.26 显示了宏块的主要预测选择，更详细介绍，参见第 5 章和第 6 章。其中包括：

* 'Skip'模式，不发送此宏块的任何信息。  
* 4 种 16x16 帧内预测模式。
* 9 种 4x4 帧内预测模式，每个 4x4 块有不同的选择模式。
* 16x16 帧间模式，从一个(P 宏块)或两个(B 宏块)列表中的参考图像进行预测。
* 8x16 帧间模式：根据上述多个参考图片进行预测，每个分区可选择不同的参考图片。
* 16x8 帧间模式：参考图片的选择如上所述。
* 8x8 帧间模式，参考图片选择如上所述。每个分块进一步划分，8x8 划分成 8x4,4x8，或4x4子宏块分区。

除了预测模式的选择外，编码器也可以选择改变量化参数(QP)。对于每种帧间模式，编码器具有非常广泛的运动矢量的选择；等等。对于宏块编码，有大量的选项可供选择。每个编码模式，即编码参数的每个组合，将倾向于产生不同数量的编码比特，范围从非常低(P-Skip 或 B-Skip)到高(帧内)以及不同的失真或重构质量。

视频编码器的目标是最小化编码比特率和最大化解码质量，或者说最小化解码失真。然后，为每个宏块选择编码模式来达到目的，是非常困难的。因为(a)编码参数的大量可能组合(b)在最小化比特率和最小化失真之间决定了"最佳"平衡问题。

### 9.5.1 率失真优化模式选择

率失真优化(RDO)模式选择是一种基于率失真代价，为每个宏块选择编码模式的技术。在其最流行的公式中，比特率代价 R 和失真代价 D 被组合成单个代价J（9.3）:  J = D + λR

RDO 模式选择算法试图找到一种使联合代价 J 最小的模式。率失真之间的平衡是通过拉格朗日乘数因子 λ 控制平衡。较小的 λ 将更加强调最小化 D，允许更高的码率；而一个更大的 λ 将倾向于以更高的失真为代价最小化 R。对于特定的序列，选择最好的 λ 是一个高度复杂的问题。幸运的是，近似的经验已经被发现了；在实际的模式选择场景中，它提供了 λ 的一个有效选择。

## 9.6 低复杂度编码

许多实用的 H.264/AVC 编解码器根本没有执行上述全速率失真优化模式选择过程的计算资源。这种实际的限制，加上最大化压缩性能的愿望，导致了数百种低复杂度编码算法和方法的开发和提出。总体目标是在率失真复杂度空间中实现性能最大化(图9.28)。低复杂度编码器往往具有较差或平均率失真性能；在选择最佳编码模式的问题上应用更多的计算，从而沿着复杂度轴移动，将倾向于提高率失真性能。因此，可以权衡压缩比特率、解码质量和编解码器复杂性。一种好的低复杂度编码方法的目标是在降低计算成本的情况下，获得良好的率失真性能。合适的比较点是“全复杂度”H.264 编码器，它在编码每个宏块时评估每个可能的编码模式、每个预测类型和每个运动矢量。

一般来说，每种低复杂度编码算法对性能的影响相似，即率失真性能往往低于基准“全复杂度”编解码器，计算复杂度也较低。然而，一些更复杂的低复杂度算法能够提供非常接近基准的编码性能，同时显著降低计算复杂度。

### 9.6.1 近似的成本函数

基本成本函数(9.3)要求计算 D 和 R。在“全面”实施中，这意味着有必要：i. 编码宏块 B 来获取 R。ii. 解码宏块来获取 B'，重建块。iii. 计算 B 和 B' 之间的失真(例如 SSD)。

为了减少计算失真所需的处理步骤的数量，已经提出了一些 SSD 近似值。例如，绝对差值之和(SAD)计算样本对 b 和 b'（9.6）之间的绝对差值。SAD 随 SSD 单调增加，但计算强度较低。计算变换域中的绝对差可以提高代价函数逼近的精度(9.7)描述了变换域度量绝对变换差之和(SATD)，其中 T 是一个变换，如Hadamrad 变换，α 是一个归一化因子.

文献中提出了对这些（或其他）失真度量的进一步快速近似，例如，替代方法是对块进行子采样，即减少待评估的采用位置(x, y)的数量。

近似编码块速率的一种简单方法是预测具有零速率的块，即所有零系数。由于所有零块在典型的编码序列中非常频繁地出现，因此在不实际编码数据的情况下预测这些块的出现可以节省大量的计算。提出了一种更为复杂的速率估计模型在里面[xviii]。

最后，可以基于先前编码帧中相同宏块位置的 R-D 代价来估计整个代价函数(9.3)[xix, xx]。

### 9.6.2 减少测试模式集

降低模式选择复杂性的第二种方法是减少为给定宏块或块测试的模式数量。

skip 模式在 P 和 B slice 中往往出现的非常频繁，尤其是当 i. 场景活动相对较低 ii.量化参数相对较高时。已经开发了许多方法，这些方法结合了基于先前宏块统计建模的早期跳过检查。

更一般地说，许多算法试图通过对模式分组和仅对某些组的模式间进行评估或编码来降低模式间选择的成本。分组可以通过先前编码的宏块的统计和/或根据当前宏块的同质性或特征来确定。

可以通过检查图像数据的结构来减少针对 MB/块 测试的帧内模式的数量。最佳帧内模式往往取决于块或宏块的特性。例如，包含平滑纹理的宏块很可能使用帧内 16x16 模式进行有效预测(参见第 6 章)。或者，特定 4x4 块的最佳帧内 4x4 模式可能与快纹理密切相关。例如，4x4 块中的主导边缘方向可用于预测最可能的预测方向。

### 9.6.3 提前终止

与减少模式数量的策略相关的是提前终止的概念，它涉及按照一定的顺序(可能是固定的或可变的)评估编码模式，并在达到一定的标准时终止该过程。例如，许多算法假设某些帧间模式的代价是单调递增或递减的，即 J<sub>16x16</sub> > J<sub>8x8</usb> > J<sub>4x4</sub>  或 J<sub>16x16</sub> < J<sub>8x8</usb> < J<sub>4x4</sub>  

如果特定模式代价不是单调的，则编码器按照预期单调性的顺序评估模式，终止模式选择过程

## 9.7 总结

了解和评估视频编码方法(如H.264/AVC)性能的一个方法是用它做实验。公共的编码器和解码器的可用性，如 JM 和 x264，使测试编码标准的各个方面成为可能。H.264/AVC 有可能提供比--当前可用的其他基于标准的和专有的编码器--一样好或更好的编码性能。然而，H.264 编解码器的性能在很大程度上取决于编码参数和原视频材料。在良好的编码性能(高质量和低比特率)和计算复杂度之间有一个基本的权衡，特别是在视频编码器中。该权衡的一个关键因素是从大量可选的选项中，为宏块选择最佳的编码模式。实用的 H.264/AVC 编码器通常使用快速、低复杂度的件货过程，来浸塑模拟全模式选择过程。
