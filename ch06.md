# H.264 预测

## 6.1 引言

H.264/AVC 被广泛应用的最主要原因可能就是它的压缩性能。如果设计和使用得到，对于给定的图像质量，H264 在压缩比方面可以超过许多其他视频编解码器。与之前的相比，H.264/AVC 之所以能有如此高的性能收益，得益于它高效的预测方法。对任意宏块，都会创建预测（目的是使用之前的编码数据来重复），从宏块中减去预测块便得到残差。预测过程的效率和精度，对于压缩性能有非常大的影响。精准的预测意味着残差包含非常少的数据，这会获得非常好的压缩性能。

H.264/AVC 支持广泛的预测选项——帧内预测使用当前帧的数据，帧间预测使用之前编码帧的运动补偿预测数据，多预测块尺寸，多参考帧以及特定的预测模式（如直接预测和加权预测）。在加上亚像素插值和减少压缩阴影的内置滤波器，这些特性使H.264编码器在预测过程中具有很大的灵活性。对每个单独宏块，通过选择最佳的预测选项，编码器可以最小化残差大小，来生成一个高压缩的码流。
 
我们首先给出宏块预测的概述，然后详细介绍 H.264/AVC 中的帧内和帧间预测。

## 6.2 宏块预测

图 6.1 展示了三种宏块的预测源，一个 I 宏块，一个 P 宏块，一个 B 宏块。I 宏块是基于当前帧中相邻采样点，通过帧内预测得到的。P 宏块是通过先前编码帧中的采样点而预测得到的，此处的先前编码帧在显示顺序上，可能在当前帧之前或之后。P 宏块内不同的矩形区域（分块）可能通过不同的参考帧获得。B 宏块的每个划分都是通过一个或两个先前编码帧预测得到。

## 6.3 帧内预测

I 宏块的编码不会参考当前 Slice 以外的任何数据。I 宏块可能在任意 slice 类型中出现。I slice 中的宏块都是 I 宏块。I 宏块的编码使用帧内预测，即预测数据来自相同 slice 中先前编码的数据。对于亮度或色度样本的典型宏块，当前宏块的样本和相邻样本之间存在较高的相关性。因此帧内预测使用相邻的样本，之前编码宏块来预测当前宏块的值。

```
图 6.2 展示了宏块的 luma 成分中的 4x4 块。当前块是图中的 10。块 0-9 已经被编码并传输，因此，当块 10 解码时，块 0-9 对解码器是可用的。这意味着块 0-9 中的任意样本都是帧内预测的候选者。而 H.264 编码器只会选择其中的 1/3/5/8 来生成一个 4x4 帧内预测。
```

在一个帧内宏块，对于 luma 成分，有三种帧内预测宏块尺寸，分别是 16x16/8x8/4x4。对于 chrom 成分，生成一个预测宏块。每个预测宏块都使用其中一种可能的预测模式（表 6.1）。
