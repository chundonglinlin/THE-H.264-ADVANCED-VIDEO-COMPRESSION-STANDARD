# H.264 预测

## 6.1 引言

H.264/AVC 被广泛应用的最主要原因可能就是它的压缩性能。如果设计和使用得到，对于给定的图像质量，H264 在压缩比方面可以超过许多其他视频编解码器。与之前的相比，H.264/AVC 之所以能有如此高的性能收益，得益于它高效的预测方法。对任意宏块，都会创建预测（目的是使用之前的编码数据来重复），从宏块中减去预测块便得到残差。预测过程的效率和精度，对于压缩性能有非常大的影响。精准的预测意味着残差包含非常少的数据，这会获得非常好的压缩性能。

H.264/AVC 支持广泛的预测选项——帧内预测使用当前帧的数据，帧间预测使用之前编码帧的运动补偿预测数据，多预测块尺寸，多参考帧以及特定的预测模式（如直接预测和加权预测）。在加上亚像素插值和减少压缩阴影的内置滤波器，这些特性使H.264编码器在预测过程中具有很大的灵活性。对每个单独宏块，通过选择最佳的预测选项，编码器可以最小化残差大小，来生成一个高压缩的码流。
 
我们首先给出宏块预测的概述，然后详细介绍 H.264/AVC 中的帧内和帧间预测。

## 6.2 宏块预测

图 6.1 展示了三种宏块的预测源，一个 I 宏块，一个 P 宏块，一个 B 宏块。I 宏块是基于当前帧中相邻采样点，通过帧内预测得到的。P 宏块是通过先前编码帧中的采样点而预测得到的，此处的先前编码帧在显示顺序上，可能在当前帧之前或之后。P 宏块内不同的矩形区域（分块）可能通过不同的参考帧获得。B 宏块的每个划分都是通过一个或两个先前编码帧预测得到。

## 6.3 帧内预测

I 宏块的编码不会参考当前 Slice 以外的任何数据。I 宏块可能在任意 slice 类型中出现。I slice 中的宏块都是 I 宏块。I 宏块的编码使用帧内预测，即预测数据来自相同 slice 中先前编码的数据。对于亮度或色度样本的典型宏块，当前宏块的样本和相邻样本之间存在较高的相关性。因此帧内预测使用相邻的样本，之前编码宏块来预测当前宏块的值。

```
图 6.2 展示了宏块的 luma 成分中的 4x4 块。当前块是图中的 10。块 0-9 已经被编码并传输，因此，当块 10 解码时，块 0-9 对解码器是可用的。这意味着块 0-9 中的任意样本都是帧内预测的候选者。而 H.264 编码器只会选择其中的 1/3/5/8 来生成一个 4x4 帧内预测。
```

在一个帧内宏块，对于 luma 成分，有三种帧内预测宏块尺寸，分别是 16x16/8x8/4x4。对于 chrom 成分，生成一个预测宏块。每个预测宏块都使用其中一种可能的预测模式（表 6.1）。

表 6.1 帧内预测类型

|帧内预测宏块尺寸 | 注释 |   
| :------: | :-----: |  
| 16x16(luma) | 一个 16x16 的预测宏块，4 种可能的预测模式 |   
| 8x8(luma) | 每个 8x8 luma 块 都生成一个 8x8 的预测宏块，9 种预测模式。仅存在于 High Profile 中 |  
| 4x4(luma) | 每个 4x4 luma 块 都生成一个 4x4 的预测宏块，9 种预测模式|  
| Chroma | 每个 chroma  分量，都生成一个预测块，4 种预测模式，所有的 chroma 分量都使用同一种预测模式 |  

对于 luma 分量，当选择 4x4 或 8x8 块尺寸时，帧内预测使用的采样点来自于当前宏块的上方、左方、左上方、右上方、或者这些的组合，这取决于当前宏块的预测模式以及这些参考宏块是否已经被编码(图 6.3)。对于 16x16 的 luma 块或 chroma 块，预测的采样点直接来自于左边或上方的块，或者两者的组合(图 6.4)。

只有真实可用的样本才可能用于预测。比如，一个位于图像或 slice 左边边界的块，它的左边并没有相邻可用的样本。因此，某些帧内预测模式对编码器并不可用。编码器为宏块从可用的预测模式中选择帧内模式。帧内模式的选择，作为编码宏块的一部分被传送到解码端。

对于 luma 分量来说，当块尺寸 16x16/4x4/8x8 都可用时，帧内预测宏块尺寸的选择会在预测效率和预测模式代价直接做一个平衡。

(a) 小的宏块：一个小的预测块尺寸(4x4)通常会给出更加准确的预测，即每个块的帧内预测与块中的实际数据很好地匹配。这意味着一个更小的编码残差，因此需要更少的 bit 来编码残差的量化变换系数。但因为对每个 4x4 宏块，都需要把预测模式选择给到解码端，这意味需要跟多的 bit 来编码预测选择。

(b) 大的宏块：较大的预测块尺寸(16x16)通常不会有那么准确的预测，因此会有更多的预测残差，但是需要更少 bit 来表示预测选择本身。

编码器通常会选择最恰当的帧内预测模式，使得用于预测和残差的 bit 总数最小。

### 6.3.1 4x4 亮度预测模式

图 6.9 给出了一个需要预测的 4x4 亮度块，它是图 6.6 中高亮块的一部分。当前宏块的上方和左方，图 6.10 中标号为 A-M 的样本，已经被编码并重建，因此对于编码器和解码器是可用的，能够用来进行预测参考。预测块 P 的样点 a, b, c, ..., p(图 6.10) 是基于样点 A-M 计算而得到的。模式 2， 进行 DC 预测的模式的计算取决于样点 A-M 的可用性。each of the other modes may only be used if all of the required prediction samples are available。注意，如果E、F、G 和 H 不可用的话，样点 D 的值会被拷贝到这些位置，并且标记为可用。

图 6.11 中的箭头表示每种模式下的预测方向。对于模式 3-8，预测样本由预测样本 A-M 的加权平均值形成。例如，如果选择模式 4，则图 6.10 中标记为 “d” 的右上角 P 样本的预测值为：`d=round（B/4 + C/2 + d/4）`。

| 模式 | 注释 |
|-----|------|
| 模式 0 | 宏块上方的样本 A/B/C/D，垂直外推 |
| 模式 1 | 宏块左方的样本 I/J/K/L，水平外推 |
| 模式 2 | 宏块内的所有样点，都是样点 A-D、I-L 的平均值预测而得 |

### 6.3.2 16x16 亮度预测模式

作为上面描述的 4x4 模式的替代，整个 16x16 宏块的 luma 分量，可以在一次操作中预测整个宏块。有 4 种模式可用，如图 6.13 所示。

| 模式 | 注释 |
|-----|------|
| 模式 0 （垂直） | 宏块上方的样本 H，垂直外推 |
| 模式 1 （水平） | 宏块左方的样本 V，水平外推 |
| 模式 2 （DC）   | 宏块内的所有样点，上方和左方采样点 H 和 V 的平均值预测而得 |
| 模式 4 （Plane）|一个线性的“平面”函数被拟合到上面和左边的样本H和V。这在亮度变化平稳的区域效果很好。|

### 6.3.3 色度预测模式

宏块的每个色度分量是从上面和/或左边的先前编码的色度样本预测得到，两个色度分量总是使用相同的预测模式。色度的四种预测模式，与 16x16 块的亮度预测模式非常相似，正如 6.3.2 节，图 6.13 所示。只是模式的编号不同。色度模式的编号是 DC （模式 0）、水平（模式 1）、垂直（模式 2）和 Plane 模式 3。

### 6.3.4 8x8 色度预测，High Profile

8x8 块的 luma 分量的帧内预测，仅在 High Profile 中可用。宏块内的每个 8x8 块，都是使用 9 种预测模式中的一种预测得到。9 种预测模式与 6.3.1 节中图 6.11 描述类似。

### 6.3.5 表示帧内预测模式

#### 6.3.5.1 4x4 或 8x8 亮度预测

对于每个 4x4 或 8x8 块的帧内预测模式的选择，都要传送到解码端。这可能需要非常多的 bit。然而相邻的 4x4 或 8x8 块的帧内模式高度相关。例如，假设 A、B、E分别代表左边、上方和当前的 4x4 宏块（如图 6.16）。若先前编码的 4x4 块 A 和 B 选用了模式 2，当前块 E 的最佳模式可能也是 2。为了利用这种相关性，需要进行预测编码来表示 4× 4 或 8 × 8 种帧内模式。这被描述成 4x4 帧内模式，8x8 模式是相似的。

对于任意当前块 E，编码端和解码端计算最有可能的预测模式，定义为 A 和 B 的预测模式中的较小者。若这些相邻的块都不可用（当前 slice 外，或不是 4x4 编码模式），对应的 A 或 B 的值设置为 2，表示 DC 预测模式。

编码器为每个 4x4 块发送一个标志位`prev_intra4×4_pred_mode`。若该标志位为1，使用最可能的预测模式。若该标志位为0，发送另外一个标志位`rem_intra4×4_pred_mode`指示模式的改变。如果`rem_intra4x4_pred_mode`当前最可能的预测模式小，则预测模式设置为`rem_intra4x4_pred_mode`;否则预测模式设置为`rem_intra4x4_pred_mode + 1`。因此只需要 8 个`rem_intra4x4_pred_mode` 值来指示 9 种可能的模式。

#### 6.3.5.2 16x16 亮度预测或色度预测

预测模式作为宏块语法的一部分用信号表示，并且不使用预测模式编码。

